<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Envíos - ONG</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Gestión de Envíos (Transferencias)</h1>
        <p>Lista de envíos de lote creados. Desde aquí puedes confirmar y validar los envíos.</p>

        <!-- Mensajes Flash y Error -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                 <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                 </div>
            {% endif %}
        {% endwith %}
        {% if error_message %}
            <p class="error-msg">Error al cargar la lista de envíos: {{ error_message }}</p>
        {% endif %}

        <!-- Tabla de Transferencias -->
        {% if shipments %}
            <table class="table-standard">
                <thead>
                    <tr>
                        <th>Referencia</th>
                        <th>Fecha Prevista</th>
                        <th>Origen</th>
                        <th>Destino</th>
                        <th>Estado Odoo</th>
                        <th style="min-width: 180px;">Acciones</th> {# Ancho mínimo para botones #}
                    </tr>
                </thead>
                <tbody>
                    {% for shipment in shipments %}
                    <tr>
                        <td>{{ shipment.name }} (ID: {{ shipment.id }})</td>
                        <td>{{ shipment.scheduled_date if shipment.scheduled_date else '-'}}</td>
                        <td>{{ shipment.location_id[1] if shipment.location_id else 'N/A' }}</td>
                        <td>{{ shipment.location_dest_id[1] if shipment.location_dest_id else 'N/A' }}</td>
                        <td>
                            {# Poner estilo simple según el estado #}
                            {% set state_style = 'color: grey;' %}
                            {% if shipment.state == 'draft' %}
                                {% set state_style = 'color: #6c757d; font-style: italic;' %} {# Gris/itálica para borrador #}
                            {% elif shipment.state == 'waiting' or shipment.state == 'confirmed' %}
                                {% set state_style = 'color: #17a2b8;' %} {# Azul claro para espera/confirmado #}
                            {% elif shipment.state == 'assigned' or shipment.state == 'ready' %}
                                {% set state_style = 'color: orange; font-weight: bold;' %} {# Naranja/negrita para listo/asignado #}
                            {% elif shipment.state == 'done' %}
                                {% set state_style = 'color: green; font-weight: bold;' %} {# Verde/negrita para completado #}
                            {% elif shipment.state == 'cancel' %}
                                {% set state_style = 'color: red; text-decoration: line-through;' %} {# Rojo/tachado para cancelado #}
                            {% endif %}
                            <span style="{{ state_style }}">{{ shipment.state }}</span>
                        </td>
                        {# === INICIO: CELDA DE ACCIONES CORREGIDA === #}
                        <td class="actions-cell">
                            {# === Lógica de Botones FINAL con RESERVAR STOCK === #}

                            {# --- 1. Botón CONFIRMAR (si está en draft) --- #}
                            {% if shipment.state == 'draft' %}
                                <form action="{{ url_for('books.confirm_shipment', picking_id=shipment.id) }}" method="POST" style="display: inline; margin-right: 5px;">
                                    <button type="submit" class="btn btn-info" title="Confirma la transferencia para iniciar proceso">➡️ Confirmar</button>
                                </form>

                            {# --- 2. Botón RESERVAR STOCK (si está confirmado/esperando) --- #}
                            {% elif shipment.state in ['confirmed', 'waiting'] %}
                                <form action="{{ url_for('books.reserve_shipment', picking_id=shipment.id) }}" method="POST" style="display: inline; margin-right: 5px;">
                                    <button type="submit" class="btn btn-warning" title="Intenta reservar el stock necesario para el envío">⏳ Reservar Stock</button>
                                </form>

                            {# --- 3. Botón VALIDAR/DETALLAR (si está asignado/listo) --- #}
                            {% elif shipment.state in ['assigned', 'ready'] %}
                                <form action="{{ url_for('books.validate_shipment', picking_id=shipment.id) }}" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-success" title="Abrir detalles para especificar cantidades y validar">✔️ Validar / Detallar</button>
                                </form>

                            {# --- Texto si ya está hecho o cancelado --- #}
                            {% elif shipment.state == 'done' %}
                                <span style="color: green; font-weight: bold;">✅ Completado</span>
                            {% elif shipment.state == 'cancel' %}
                                <span style="color: red;">❌ Cancelado</span>
                            {% endif %}
                        </td>
                        {# === FIN: CELDA DE ACCIONES CORREGIDA === #}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% elif not error_message %}
             <p class="no-items">No hay envíos de lote creados que mostrar.</p>
        {% endif %}

        <hr>
         <div class="form-actions" style="text-align: left;">
             <a href="{{ url_for('main.index') }}" class="btn">Volver a Inicio</a>
         </div>
    </div>
</body>
</html>